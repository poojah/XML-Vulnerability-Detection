<?php
session_start();
$results = array();

//this is a very simple, potentially very slow search
function extractText($array){
	if(count($array) <= 1){
		//we only have one tag to process!
		for ($i = 0; $i<count($array); $i++){
			$node = $array->item($i);
			$value = $node->nodeValue;
		}
		return $value;
	} 
	
}	

$dh = opendir('./xml/');

while ($file = readdir($dh)){
	if (preg_match("/^\\.\\.?$/", $file)) {
		continue;
	}
	$open = "./xml/" . $file;
	$xml = new DomDocument;
	@$xml ->load($open);
	$root = $xml->documentElement;
	
	//echo $open."\r\n";
	$id = $root->getAttribute("id");
	//echo "\r\n";
	//echo $id;

	$h_array = $root->getElementsByTagname("headline");
	$headline = extractText($h_array);
	//echo $headline;

	//$stat_array = $root->getElementsByTagname("status");
	//$status = extractText($stat_array);

		
	//$a_array = $root->getElementsByTagname("author");
	//$author = extractText($a_array);
	//echo $author;
	
	//$e_array = $root->getElementsByTagname("email");
	//$email = extractText($e_array);
	//echo $email;

	$ab_array = $root->getElementsByTagname("abstract");
	$abstract = extractText($ab_array);

	//$kl_array = $root->getElementsByTagname("keywords");
	//$keywords = extractText($kl_array);
	//echo $keywords;
	
	//$lead_array = $root->getElementsByTagname("para-intro");
	//$para["intro"] = extractText($lead_array);

	//$second_array = $root->getElementsByTagname("para-main");
	//$para["main"] = extractText($second_array);

	//$con_array = $root->getElementsByTagname("para-conclusion");
	//$para["con"] = extractText($con_array);
	

//	if ($status != "live"){
//		continue;
//	}

	$searchTerm=$_POST['searchTerm'];
	//echo $searchTerm;
	$searchTerm="/".$searchTerm."/";
	//echo $searchTerm;
	//$searchTerm="\"".$searchTerm."\"";
	//echo $searchTerm;

	if (  preg_match($searchTerm,$headline)){
		$list['abstract'] = $abstract;
		$list['headline'] = $headline;
		$list['file'] = $file;
		$results[] = $list;
	}

}

$results = array_unique($results);
$searchTerm=$_POST['searchTerm'];
?>

<h1>Search Results</h1>
<a href="index.php">back to main</a>
<p>You searched for: <i><?php echo $searchTerm ?></i></p>
<hr>


<?php

if (count($results)>0){
	echo "<p>Your search results:</p>";
	foreach ($results as $key => $listing){
		echo "<br><a href=\"showArticle.php?file=".$listing["file"]."\">" . $listing["headline"]."</a>\n";
		echo "<br>". $listing["abstract"];
		echo "<br>";
	}
} else {

	echo "<p>Sorry, no articles matched your search term.</p>";
}

?>