<?php
//stripslashes

$headline=$_POST['headline'];
$headline = stripslashes($headline);
$name=$_POST['name'];
$name = stripslashes($name);
$email=$_POST['email'];
$email = stripslashes($email);
$abstract=$_POST['abstract'];
$abstract = stripslashes($abstract);
$keywords=$_POST['keywords'];
$keywords = stripslashes($keywords);

//create document root
$doc = new DOMDocument("1.0");
$doc->saveXML();
$root = $doc->createElement("article");
$root = $doc->appendChild($root);

//add ID attribute
//FIRST, let's make sure that the id they chose isn't going to overwrite a file!
$dh = opendir('./xml/');

while ($file = readdir($dh)){
	$id=$_POST['id'];
	$string = $id . ".xml";
	$string = "/".$string."/";
	
	if (preg_match("/^\\.\\.?$/", $file)) {
		continue;
	}
	if (preg_match($string, $file)){
		$time = date("U"); //number of seconds since unix epoch
		$id = $id . "-" . $time;
	}
}


$root->setAttribute('id', $id);

//create headline
$head = $doc->createElement("headline");
$head = $root->appendChild($head);
$htext = $doc->createTextNode($headline);
$htext = $head->appendChild($htext);

//create author name
$aname = $doc->createElement("author");
$aname = $root->appendChild($aname);
$atext = $doc->createTextNode($name);
$atext = $aname->appendChild($atext);

//create author email
$mail = $doc->createElement("email");
$mail = $root->appendChild($mail);
$mtext = $doc->createTextNode($email);
$mtext = $mail->appendChild($mtext);

//create abstract
$abs = $doc->createElement("abstract");
$abs = $root->appendChild($abs);
$abstext = $doc->createTextNode($abstract);
$abstext = $abs->appendChild($abstext);

//create keyword listing
$keylisting = $doc->createElement("keywords");
$keylisting = $root->appendChild($keylisting);
$ktext = $doc->createTextNode($keywords);
$ktext = $keylisting->appendChild($ktext);

//create status, always in progress when first created
//$stat = $doc->createElement("status");
//$stat = $root->appendChild($stat);
//$stat_text = $doc->createTextNode($status);
//$stat_text = $stat->appendChild($stat_text);


//create paras
$body=$_POST['body'];
if (is_array($body)){
	foreach ($body as $K => $V){
		
		if ($V != ""){
			$V = stripslashes($V);
			$para = $doc->createElement("para-$K");
			$para = $root->appendChild($para);
			$ptext = $doc->createTextNode($V);
			$ptext = $para->appendChild($ptext);
			$para->setAttribute('order', $K);
		}
	}
}



//write to the file
$filename = "./xml/".$id . ".xml";
$doc->save($filename);

//send user back to adminindex
header("Location:adminindex.php");
?>